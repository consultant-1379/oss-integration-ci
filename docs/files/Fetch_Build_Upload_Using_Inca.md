# OSS Integration Fetch, build & upload chart/helmfile Jenkins file using ADP's INCA Docker Image

>> **Note:**
> If the snapshot is to be created only, checkout the option using the [Development Chart Creation Jenkins file](Dev_Chart_Creation.md)
> it would run a lot faster to generate a snapshot

[TOC]

## Introduction

This file is used to generate either a chart or helmfile which can be used in the different testing phases.
It can be used to generate either a snapshot of the artifact or a released version of the artifact.
The Jenkins file uses the ADP INCA image as the backbone of its execution, more details on the working of INCA can be
seen [here](https://gerrit-gamma.gic.ericsson.se/plugins/gitiles/adp-cicd/adp-int-helm-chart-auto)

## Overview

Currently, when the file is executed it will:

- Clean down the Jenkins workspace before starting a new test flow.
- The paramaters provided are passed the INCA docker image, where it will perform a number of steps,
  - Downloads the artifact repo to a tmp location
  - checks what version should be used next.
  - Upload the generated package to the appropriate repo
  - tags the repo with the appropriate version for tracking


### Repo Files
The following files within the oss-integration-ci [repo](https://gerrit-gamma.gic.ericsson.se/#/admin/projects/OSS/com.ericsson.oss.aeonic/oss-integration-ci)
are used in its execution.
- ci/jenkins/files/packaging/fetchBuildUploadUsingInca.Jenkinsfile *(Main Jenkins File)*
- ci/jenkins/rulesets/ruleset2.0.yaml

### Resources

The following is an example of the Jenkinsfile used in a job within the Base flows
- [Jenkins Jobs](https://fem5s11-eiffel052.eiffel.gic.ericsson.se:8443/jenkins/job/OSS-Integration-Fetch-Build-Upload-Using-ADP-Inca/)

### Parameters

#### Input Parameters

The following is a list of parameters that are used within the file.

| Parameter                        | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Default                              |
|----------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------|
| GERRIT_USER_SECRET               | Jenkins secret ID with Gerrit username and password.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                                      |
| ARMDOCKER_USER_SECRET            | Jenkins secret to log onto the Docker Arm.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                                      |
| GERRIT_REFSPEC                   | Gerrit refspec of the app under tests example: refs/changes/88/9999988/9 - 88 - last 2 digits of Gerrit commit number / 9999988 - is Gerrit commit number / 9 - patch number of gerrit commit.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                                      |
| CHART_NAME                       | Comma-separated dependency helm chart name list. E.g.: eric-pm-server, eric-data-document-database-pg'. Used to find the specific chart name in the Chart.yaml to swap the correct version for the service. GERRIT_REFSPEC should be blank if using this value.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                                      |
| CHART_VERSION                    | Comma-separated dependency helm chart version list. E.g.: 1.0.0+66, 2.3.0+57. Used to swap out the version according to the CHART_NAME specified in the Chart.yaml. GERRIT_REFSPEC should be blank if using this value.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                                      |
| CHART_REPO                       | Comma-separated dependency helm chart url list. E.g.: https://arm.rnd.ki.sw.ericsson.se/artifactory/proj-pm-1,https://arm.rnd.ki.sw.ericsson.se/artifactory/proj-pm-2'. GERRIT_REFSPEC should be blank if using this value.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                      |
| GIT_REPO_URL                     | Gerrit https url to app git repo. Example: https://gerrit-gamma.gic.ericsson.se/adp-cicd/demo-app-release-chart.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                                      |
| CHART_PATH                       | Relative path to app chart in git repo.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                                      |
| HELM_INTERNAL_REPO               | Repository to upload the snapshot version to.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                                      |
| HELM_DROP_REPO                   | Drop repository url.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                                      |
| HELM_REPO_CREDENTIALS_ID         | Repositories.yaml file credential used for auth.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                                      |
| SPINNAKER_PIPELINE_ID            | ID of the associated Spinnaker pipeline. Used as a placeholder in order to mitigate Jenkins 404 errors.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | 123456                               |
| VCS_BRANCH                       | Branch for the change to be pushed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | master                               |
| STATE_VALUES_FILE                | Relative path to the Site values file that is used for the helmfile build, this pre-populated file can be found in the oss-integration-ci repo, <br> e.g. <br> [EO Prepopulated file](https://gerrit-gamma.gic.ericsson.se/plugins/gitiles/OSS/com.ericsson.oss.aeonic/oss-integration-ci/+/refs/heads/master/site-values/eo/ci/override/override-site-values-helmfile-template.yaml) : site-values/eo/ci/override/override-site-values-helmfile-template.yaml <br> [EIC Prepopulated file](https://gerrit-gamma.gic.ericsson.se/plugins/gitiles/OSS/com.ericsson.oss.aeonic/oss-integration-ci/+/refs/heads/master/site-values/idun/ci/override/override-site-values-helmfile-template.yaml) : site-values/idun/ci/override/override-site-values-helmfile-template.yaml | None                                 |
| CI_HELM                          | If set to true, the ci-helm command will be used to package the helm chart.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | true                                 |
| ALLOW_DOWNGRADE                  | Default is 'false', if set to true, downgrade of dependency is allowed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | false                                |
| VERSION_CHECK_DOWNGRADE          | Default is 'false', if set to true, version is allowed to step backwards one step only (e.g. 7.1.0-1 -> 7.0.0-1). If set to false, any version step backwards is allowed (E.g. 7.1.0-1 -> 5.1.3-7).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | false                                |
| IGNORE_NON_RELEASED              | Default is 'false', if set to true, wont upload helm chart to drop or release repo if CHART_VERSION is non-released (e.g. 1.0.0-11).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | false                                |
| AUTOMATIC_RELEASE                | Default is 'false', if set to true, publish integration helm chart to released repo if all dependencies are released.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | false                                |
| ALWAYS_RELEASE                   | Default is 'true', if set to true, Always upload to released repo with released version, AUTOMATIC_RELEASE is ignored is this is set to true.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | true                                 |
| VERSION_STEP_STRATEGY_DEPENDENCY | Possible values: MAJOR, MINOR, PATCH. Step this digit automatically in Chart.yaml after release when dependency change received. Default is MINOR.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | MINOR                                |
| VERSION_STEP_STRATEGY_MANUAL     | Possible values: MAJOR, MINOR, PATCH. Step this digit automatically in Chart.yaml after release when manaul change received. Default is MINOR.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | MINOR                                |
| GERRIT_PREPARE_OR_PUBLISH        | prepare-dev :: Prepare Integration Helm Chart for development<br>prepare :: Prepare Integration Helm Chart<br>publish :: Checks in the updates to git and upload to the release repo<br>prep :: Builds a local copy of the snapshot tar file and executes the precode tests against the updated chart.                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | prepare                              |
| CHECK_PUBLISHED                  | If set to true, and the parameter GERRIT_PREPARE_OR_PUBLISH is set to "publish", the console output will be checked to ensure a new helm chart has been uploaded. <br>If a new chart was not created the job will fail. <br>Used for Helm charts only.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | true                                 |
| COMMIT_MESSAGE_FORMAT_MANUAL     | User defined manual git commit message format string template.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | %ORIGINAL_TITLE (%INT_CHART_VERSION) |
| GIT_TAG_ENABLED                  | Create a tag for the git commit, default is false.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | true                                 |
| WAIT_SUBMITTABLE_BEFORE_PUBLISH  | For the publish command, wait for the gerrit patch to be set for a verified +1 or +2 or both before submitting, default is true.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | true                                 |
| WAIT_TIMEOUT_SEC_BEFORE_PUBLISH  | Timeout in seconds wait for a verifed +1 or +2 or both before submitting. Default is 120s.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | 120                                  |
| TIMEOUT                          | Time to wait in seconds before the job should timeout                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | 3600                                 |
| SUBMODULE_SYNC_TIMEOUT           | Number of seconds before the submodule sync command times out                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 60                                   |
| SUBMODULE_UPDATE_TIMEOUT         | Number of seconds before the submodule update command times out                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | 300                                  |
| SLAVE_LABEL                      | Specify the slave label that you want the job to run on.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | evo_docker_engine                    |
| CI_REFSPEC                       | Can be used to fetch job JenkinsFile from branch (refs/heads/master) or commit (refs/changes/95/156395/1) / 95 - last 2 digits of Gerrit commit number / 156395 - is Gerrit commit number / 1 - patch number of gerrit commit / Only to be used during testing.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | refs/heads/master                    |
>> **Note** See the following page for more details on credential's storage, [README](Credentials_Storage.md)

#### Output File

On a successful execution an artifact.properties file is created, this artifact list the details of the created chart.

e.g.

```
CHART_NAME=eric-oss-pm-stats-calc-handling
CHART_VERSION=0.342.0
CHART_REPO=https://arm.seli.gic.ericsson.se/artifactory/proj-eric-oss-drop-helm-local
INT_CHART_NAME=eric-eiae-helmfile
INT_CHART_VERSION=2.254.0
INT_CHART_REPO=https://arm.seli.gic.ericsson.se/artifactory/proj-eric-oss-drop-helm
INT_CHART_NAME_STABLE=None
INT_CHART_VERSION_STABLE=None
INT_CHART_REPO_STABLE=None
TYPE_DEPLOYMENT=publish
```

## Jenkins Job Configuration

> **Note:** to create a new Jenkins job the user should have the correct access rights to the Jenkins server

If the job needs to be created on a Jenkins server, the following needs to be followed

- Create a new Pipeline Jenkins Job
- Within the "Pipeline Section" of the Jenkins Job Configuration set the following
    * **Definition:** Pipeline script from SCM
    * **SCM:** Git
    * **Repositories URL:** ${GERRIT_MIRROR}/OSS/com.ericsson.oss.aeonic/oss-integration-ci
    * **Credentials:** Choose appropriate credentials for Gerrit cloning
    * **Branches to build:** master
    * **Script Path:** ci/jenkins/files/packaging/fetchBuildUploadUsingInca.Jenkinsfile
> **Note:** Once the repo has been configured in the Jenkins job, there is no need to configure the parameters, the job on execution
will automatically create all the parameter(s) on the first execution. The job will fail though.

### Testing

In order to test a Jenkins file (Without affecting the master branch), please refer to the [Contributing Guide](../Contribution_Guide.md).

## Contributing

We are an inner source project and welcome contributions. See our
[Contributing Guide](../Contribution_Guide.md) for details.

## Contacts

### Guardians

See in [Contributing Guide](../Contribution_Guide.md)

### Backlog

Create a new issue on Ticketmaster component under ADPPRG project:

Report [Support/Bug](https://jira-oss.seli.wh.rnd.internal.ericsson.com/browse/IDUN-4091)

See in [Contributing Guide](../Contribution_Guide.md) for further details

### Support

Support is available on our Teams channel:

- Send questions via
  [Ticketmaster - General](https://teams.microsoft.com/l/channel/19%3a9f5ed758e3a6405daffee42e0284268b%40thread.skype/General?groupId=1483901a-b5c4-445a-b707-aa7a5d0c1b4c&tenantId=92e84ceb-fbfd-47ab-be52-080c6b87953f)
  Microsoft Teams channel
