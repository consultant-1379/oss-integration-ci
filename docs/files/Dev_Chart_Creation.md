# OSS Integration Dev Chart Creation using a dependency cache JenkinsFile

>> **Note:**
> This file is only to be used to generate a snapshot version of the chart under test. It is not to be used to
> release a chart version to the drop or releases repo. ADPs INCA should be used to perform a full release to the drop
> or releases repo.

[TOC]

## Introduction

This file is used to generate a development/snapshot of helm chart which can be used for testing purposes. This jenkins
file has the option to build using a local cache of the dependencies to make the building of the chart fast and
reduces the load on the network. If a dependency is not in the local cache it will be downloaded on that execution and
added to the cache for the next execution.

## Overview

Currently, when the file is executed it will:

- Clean down the Jenkins workspace before starting a new test flow.
- Install the required Docker config which will be required to execute the different test phases.
- Fetch the chart repo according to the gerrit project details entered. Will then either merge the gerrit refspec on top
or update the Chart Details in the Chart.yaml.
- Set the next Dev chart version, using the current version of the Chart, it will add a build number and a unique identifier.
This unique identifier is generated by adding "tm" and the git sha from Head together, e.g tm123456, example of the full
version, 1.2.3-1-tm123456.
- Will build the new chart.
- Newly created chart will be uploaded to the internal snapshot repo specified, if the upload option is set. Else the
artifact will be added to the jenkins file as an attached artifact for local testing.


### Repo Files
The following files within the oss-integration-ci [repo](https://gerrit-gamma.gic.ericsson.se/#/admin/projects/OSS/com.ericsson.oss.aeonic/oss-integration-ci)
are used in its execution.
- ci/jenkins/files/packaging/packageChartUsingCiHelm.Jenkinsfile *(Main Jenkins File)*
- ci/jenkins/rulesets/ruleset2.0.yaml

### Resources

The following job is used within the Base flows
- [Jenkins Jobs](https://fem7s11-eiffel216.eiffel.gic.ericsson.se:8443/jenkins/job/OSS-Integration-Package-Chart-Using-CIHelm/)

### Parameters

#### Input Parameters

The following is a list of parameters that are used within the file.

| Parameter                  | Description                                                                                                                                                                                                                                                    | Default                                                                  |
|----------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------|
| GERRIT_REFSPEC             | Gerrit refspec of the app under tests example: refs/changes/88/9999988/9 - 88 - last 2 digits of Gerrit commit number / 9999988 - is Gerrit commit number / 9 - patch number of gerrit commit                                                                  |                                                                          |
| CHART_NAME                 | Comma-separated dependency helm chart name list. E.g.: eric-pm-server, eric-data-document-database-pg'. Used to find the specific chart name in the Chart.yaml to swap the correct version for the service. GERRIT_REFSPEC should be blank if using this value |                                                                          |
| CHART_VERSION              | Comma-separated dependency helm chart version list. E.g.: 1.0.0+66, 2.3.0+57. Used to swap out the version according to the CHART_NAME specified in the Chart.yaml. GERRIT_REFSPEC should be blank if using this value                                         |                                                                          |
| CHART_REPO                 | Comma-separated dependency helm chart url list. E.g.: https://arm.rnd.ki.sw.ericsson.se/artifactory/proj-pm-1,https://arm.rnd.ki.sw.ericsson.se/artifactory/proj-pm-2'. GERRIT_REFSPEC should be blank if using this value                                     |                                                                          |
| GIT_REPO_URL               | Gerrit https url to app git repo. Example: https://gerrit-gamma.gic.ericsson.se/adp-cicd/demo-app-release-chart                                                                                                                                                          |                                                                          |
| GERRIT_PROJECT             | Gerrit project details e.g. OSS/com.ericsson.oss/oss-common-base                                                                                                                                                                                               |                                                                          |
| HELM_INTERNAL_REPO         | Repository to upload the snapshot version to                                                                                                                                                                                                                   |                                                                          |
| VCS_BRANCH                 | Branch for the change to be pushed                                                                                                                                                                                                                             | master                                                                   |
| CHART_PATH                 | Relative path to app chart in git repo.                                                                                                                                                                                                                        |                                                                          |
| USE_DEPENDENCY_CACHE       | If set to true, it uses the dependency cache directory within /tmp/cachedir to push and pull dependency from. See [Dependency Cache](#Dependency-Cache) for more details                                                                                       | false                                                                    |
| DEPENDENCY_CACHE_DIRECTORY | Specify the cache directory on the Jenkins Agent to push and pull dependencies from. See [Dependency Cache](#Dependency-Cache) for more details                                                                                                                | /tmp/cachedir                                                            |
| ALLOW_DOWNGRADE            | Default is 'false', if set to true, downgrade of dependency is allowed.                                                                                                                                                                                        | false                                                                    |
| VERSION_CHECK_DOWNGRADE    | Default is 'false', if set to true, version is allowed to step backwards one step only (e.g. 7.1.0-1 -> 7.0.0-1). If set to false, any version step backwards is allowed (E.g. 7.1.0-1 -> 5.1.3-7).                                                            | false                                                                    |
| GERRIT_USER_SECRET         | Jenkins secret ID with Gerrit username and password                                                                                                                                                                                                            |                                                                          |
| ARTIFACT_UPLOAD_TO_ARM     | If set to true, will upload the artifact to the specified ARM repository, else it will be attached to the jenkins job as an artifact for local testing                                                                                                         | true                                                                     |
| ARMDOCKER_USER_SECRET      | Jenkins secret to log onto the Docker Arm                                                                                                                                                                                                                      |                                                                          |
| HELM_REPO_CREDENTIALS_ID   | Repositories.yaml file credential used for auth                                                                                                                                                                                                                |                                                                          |
| FUNCTIONAL_USER_TOKEN      | Jenkins secret token ID for ARM Registry Token.                                                                                                                                                                                                                |                                                                          |
| TIMEOUT                    | Time to wait in seconds before the job should timeout                                                                                                                                                                                                          | 3600                                                                     |
| SUBMODULE_SYNC_TIMEOUT     | Number of seconds before the submodule sync command times out                                                                                                                                                                                                  | 60                                                                       |
| SUBMODULE_UPDATE_TIMEOUT   | Number of seconds before the submodule update command times out                                                                                                                                                                                                | 300                                                                      |
| SLAVE_LABEL                | Specify the slave label that you want the job to run on.                                                                                                                                                                                                       | evo_docker_engine                                                        |
| CI_DOCKER_IMAGE            | CI Docker image to use. Mainly used in CI Testing flows                                                                                                                                                                                                        | armdocker.rnd.ericsson.se/proj-eric-oss-drop/eric-oss-ci-scripts:default |
| CI_REFSPEC                 | Can be used to fetch job JenkinsFile from branch (refs/heads/master) or commit (refs/changes/95/156395/1) / 95 - last 2 digits of Gerrit commit number / 156395 - is Gerrit commit number / 1 - patch number of gerrit commit / Only to be used during testing | refs/heads/master                                                        |
>> **Note** See the following page for more details on credential's storage, [README](Credentials_Storage.md)

#### Output File

On a successful execution an artifact.properties file is created, this artifact list the details of the created chart.

e.g.

```
INT_CHART_NAME=eric-oss-common-base
INT_CHART_VERSION=0.48.1-1-tm4826e09
INT_CHART_REPO=https://arm.seli.gic.ericsson.se/artifactory/proj-eric-oss-ci-internal-helm
INT_CHART_NAME_STABLE=None
INT_CHART_VERSION_STABLE=None
INT_CHART_REPO_STABLE=None
```

## Dependency Cache (UNDER DEVELOPMENT - BETA RELEASE)
There is an option in the job, "USE_DEPENDENCY_CACHE", if this is set to true it will use the default cache within the
/tmp/cachedir directory on the Jenkins agent.

If the directory does not exist it will be created with full permissions, "777", to allow any user executing a jenkins
job have access to the directory. On the first execution of the job against an empty cache dir it will take extra time
to pull all the dependencies the first time.

This directory will be used in two ways,
- To push the new dependency found within the chart to the cache, so they are available for the next iteration.
- To pull the dependency from the cache, instead of pulling them down over the network, if already available in the cache.

## Jenkins Job Configuration

> **Note:** to create a new Jenkins job the user should have the correct access rights to the Jenkins server

If the job needs to be created on a Jenkins server, the following needs to be followed

- Create a new Pipeline Jenkins Job
- Within the "Pipeline Section" of the Jenkins Job Configuration set the following
    * **Definition:** Pipeline script from SCM
    * **SCM:** Git
    * **Repositories URL:** ${GERRIT_MIRROR}/OSS/com.ericsson.oss.aeonic/oss-integration-ci
    * **Credentials:** Choose appropriate credentials for Gerrit cloning
    * **Branches to build:** master
    * **Script Path:** ci/jenkins/files/packaging/packageChartUsingCiHelm.Jenkinsfile
> **Note:** Once the repo has been configured in the Jenkins job, there is no need to configure the parameters, the job on execution
will automatically create all the parameter(s) on the first execution. The job will fail though.

### Testing

In order to test a Jenkins file (Without affecting the master branch), please refer to the [Contributing Guide](../Contribution_Guide.md).

## Contributing

We are an inner source project and welcome contributions. See our
[Contributing Guide](../Contribution_Guide.md) for details.

## Contacts

### Guardians

See in [Contributing Guide](../Contribution_Guide.md)

### Backlog

Create a new issue on Ticketmaster component under ADPPRG project:

Report [Support/Bug](https://jira-oss.seli.wh.rnd.internal.ericsson.com/browse/IDUN-4091)

See in [Contributing Guide](../Contribution_Guide.md) for further details

### Support

Support is available on our Teams channel:

- Send questions via
  [Ticketmaster - General](https://teams.microsoft.com/l/channel/19%3a9f5ed758e3a6405daffee42e0284268b%40thread.skype/General?groupId=1483901a-b5c4-445a-b707-aa7a5d0c1b4c&tenantId=92e84ceb-fbfd-47ab-be52-080c6b87953f)
  Microsoft Teams channel
