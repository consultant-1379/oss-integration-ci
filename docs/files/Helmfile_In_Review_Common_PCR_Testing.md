# Helmfile in Review Common PCR Testing File.

[TOC]

## Introduction

The job is used to execute the PCR against the given helmfile. It is triggered by a gerrit event when a helmfile change is pushed for review.
This file works in conjunction with the [Common Helmfile Testing Jenkins file](Common_Helmfile_Test.md), both files need to exist.


## Overview
Currently, when the file is executed,
- The Jenkins job will take in parameters from the user (All Input Parameters are listed in more detail below).
- It will perform git clean of the workspace.
- It will then call a downstream job, to execute the Common App testing flow.

### Repo Files
The following files within the oss-integration-ci [repo](https://gerrit-gamma.gic.ericsson.se/#/admin/projects/OSS/com.ericsson.oss.aeonic/oss-integration-ci)
are used in its execution.
- ci/jenkins/files/helmfile/pcr/helmfileInReviewCommonPCRTest.Jenkinsfile *(Main Jenkins File)*
- ci/jenkins/rulesets/ruleset2.0.yaml

### Downstream Job
Downstream Job that is triggered as a result of this Jenkinsfile, is based off the following Jenkinsfile within the oss-integration-ci repo.
[Downstream Job Jenkinsfile](https://gerrit-gamma.gic.ericsson.se/plugins/gitiles/OSS/com.ericsson.oss.aeonic/oss-integration-ci/+/refs/heads/master/ci/jenkins/files/helmfile/pcr/commonHelmfileTest.Jenkinsfile)

Documentation on the file can be seen on the following link:
[Downstream Job Documentation](https://gerrit-gamma.gic.ericsson.se/plugins/gitiles/OSS/com.ericsson.oss.aeonic/oss-integration-ci/+/refs/heads/master/docs/files/Common_Helmfile_Test.md)

### Parameters

#### Input Parameters

The following is a list of parameters that are used within the file.

| Parameter                                 | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Default                                 |
|-------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------|
| CHART_PATH                                | Relative path to helmfile local chart/charts in git repo.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                                         |
| GERRIT_PROJECT                            | Gerrit project details e.g. OSS/com.ericsson.oss.eiae/eiae-helmfile                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                         |
| GERRIT_USER_SECRET                        | Jenkins secret ID with Gerrit username and password                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                                         |
| FUNCTIONAL_USER_SECRET                    | Jenkins secret ID with ARM Docker config details                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                                         |
| ARMDOCKER_USER_SECRET                     | Jenkins secret to log onto the Docker Arm                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                                         |
| PCR_MASTER_JOB_NAME                       | This is the common app testing job that will be triggered by this job to execute the test                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | OSS-Integration-Helmfile-Common-Testing |
| PATH_TO_SITE_VALUES                       | The full path to the ci site values template file for the Helmfile under test                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                         |
| PATH_TO_SITE_VALUES_OVERRIDE_FILE         | The full path to the ci site values override template file for the additional values needed for the Helmfile under test                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                                         |
| KUBERNETES_COMPATIBILITY_SITE_VALUES_PATH | The full path to the kubernetes compatibility site values file used during the Kubernetes Testing Phase                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                                         |
| KUBEVAL_KINDS_TO_SKIP                     | Skipped Kubeval checks for specific kinds. Current skips for eo-helmfile - "HTTPProxy,CertificateAuthority,ClientCertificate,InternalCertificate,InternalUserCA,ServerCertificate,CustomResourceDefinition,DestinationRule,EnvoyFilter,PeerAuthentication,Gateway,Sidecar,Telemetry,template,VirtualService,CassandraCluster,Kafka,KafkaBridge,ExternalCertificate,RedisCluster". Current skips for eiae-helmfile - "HTTPProxy,ServerCertificate,InternalCertificate,ClientCertificate,CertificateAuthority,adapter,attributemanifest,AuthorizationPolicy,CustomResourceDefinition,CassandraCluster,DestinationRule,EnvoyFilter,Gateway,handler,HTTPAPISpec,HTTPAPISpecBinding,instance,PeerAuthentication,QuotaSpec,QuotaSpecBinding,RbacConfig,RequestAuthentication,rule,ServiceEntry,ServiceRole,ServiceRoleBinding,Sidecar,Telemetry,template,VirtualService,WorkloadEntry,WorkloadGroup,Kafka,KafkaBridge,RedisCluster,ExternalCertificate,InternalUserCA" |                                         |
| HELMFILE_NAME                             | The name of the Helmfile under test e.g. eiae-helmfile/eo-helmfile. Very important as it is used to set the build name and conditionally run certain Helmfile-specific stages                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                                         |
| TIMEOUT                                   | Time to wait in seconds before the job should timeout                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 3600                                    |
| SUBMODULE_SYNC_TIMEOUT                    | Number of seconds before the submodule sync command times out                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | 60                                      |
| SUBMODULE_UPDATE_TIMEOUT                  | Number of seconds before the submodule update command times out                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | 300                                     |
| SLAVE_LABEL                               | Specify the slave label that you want the job to run on.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | evo_docker_engine                       |
| CI_REFSPEC                                | Can be used to fetch job JenkinsFile from branch (refs/heads/master) or commit (refs/changes/95/156395/1) / 95 - last 2 digits of Gerrit commit number / 156395 - is Gerrit commit number / 1 - patch number of gerrit commit / Only to be used during testing                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | refs/heads/master                       |

>> **Note** See the following page for more details on credential's storage, [README](Credentials_Storage.md)

## Jenkins Job Configuration

> **Note:** to create a new Jenkins job the user should have the correct access rights to the Jenkins server

If the job needs to be created on a Jenkins server, the following needs to be followed

- Create a new Pipeline Jenkins Job
- Within the "Build Triggers Section" of the Jenkins Job Configuration set the following
    * **Gerrit event:** Selected
    * **Trigger on:** Patchset Created
    * **Trigger on:** Draft Published

- Within the "Pipeline Section" of the Jenkins Job Configuration set the following
    * **Definition:** Pipeline script from SCM
    * **SCM:** Git
    * **Repositories URL:** ${GERRIT_MIRROR}/OSS/com.ericsson.oss.aeonic/oss-integration-ci
    * **Credentials:** Choose appropriate credentials for Gerrit cloning
    * **Branches to build:** FETCH_HEAD
    * **Advanced - Refspec:** ${CI_REFSPEC}
    * **Advanced Behaviours - Advanced Clone Behaviours:** Honor refspec on initial clone
    * **Advanced Behaviours - Advanced Clone Behaviours:** Shallow Clone - Shallow Clone depth - 1
    * **Script Path:** ci/jenkins/files/helmfile/pcr/helmfileInReviewCommonPCRTest.Jenkinsfile
> **Note:** Once the repo has been configured in the Jenkins job, there is no need to configure the parameters, the job on execution
will automatically create all the parameter(s) on the first execution. The job will fail though.

### Testing

In order to test a Jenkins file (Without affecting the master branch), please refer to the [Contributing Guide](../Contribution_Guide.md).

## Contributing

We are an inner source project and welcome contributions. See our
[Contributing Guide](../Contribution_Guide.md) for details.

## Contacts

### Guardians

See in [Contributing Guide](../Contribution_Guide.md)

### Backlog

Create a new issue on Ticketmaster component under ADPPRG project:

Report [Support/Bug](https://jira-oss.seli.wh.rnd.internal.ericsson.com/browse/IDUN-4091)

See in [Contributing Guide](../Contribution_Guide.md) for further details

### Support

Support is available on our Teams channel:

- Send questions via
  [Ticketmaster - General](https://teams.microsoft.com/l/channel/19%3a9f5ed758e3a6405daffee42e0284268b%40thread.skype/General?groupId=1483901a-b5c4-445a-b707-aa7a5d0c1b4c&tenantId=92e84ceb-fbfd-47ab-be52-080c6b87953f)
  Microsoft Teams channel
